{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="row">
  <div class="col-12">

    <!-- Encabezado -->
    <div class="d-flex align-items-center mb-3">
      <h5 class="mb-0">Mis tareas (Supervisor)</h5>
      <span class="text-muted ml-3">Resultados: {{ page_obj.paginator.count }}</span>
      <div class="ml-auto">
        <a href="{% url 'tarea_create' %}" class="btn btn-primary btn-sm">
          <i class="fe fe-plus mr-1"></i> Crear tarea
        </a>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
      <div class="card-body">
        <form method="get" class="mb-0">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label class="small text-muted mb-1">Buscar</label>
              <input type="text" name="q" value="{{ request.GET.q }}" class="form-control"
                     placeholder="Título o descripción…">
            </div>
            <div class="form-group col-md-3">
              <label class="small text-muted mb-1">Estado</label>
              <select name="estado" class="form-control">
                <option value="">Todos</option>
                {% for e in ESTADOS %}
                  <option value="{{ e }}" {% if request.GET.estado == e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3 d-flex align-items-end">
              {% if request.GET %}
                <a href="{% url 'tarea_list_supervisor_mias' %}" class="btn btn-light mr-2">
                  <i class="fe fe-x"></i> Limpiar
                </a>
              {% endif %}
              <button type="submit" class="btn btn-secondary">
                <i class="fe fe-filter mr-1"></i> Filtrar
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="thead-light">
              <tr>
                <th>Título</th>
                <th>Departamento</th>
                <th>Estado</th>
                <th>Vence</th>
                <th class="text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tareas %}
              <tr>
                <td class="align-middle">
                  <a href="{% url 'tarea_detail' t.pk %}?src=mias">{{ t.titulo }}</a>
                </td>
                <td class="align-middle text-muted">{{ t.departamento.nombre }}</td>
                <td class="align-middle">
                  {% if t.estado == "Pendiente" %}
                    <span class="badge badge-warning text-dark">Pendiente</span>
                  {% elif t.estado == "En progreso" %}
                    <span class="badge badge-info">En progreso</span>
                  {% elif t.estado == "Atrasada" %}
                    <span class="badge badge-danger">Atrasada</span>
                  {% elif t.estado == "Finalizada" %}
                    <span class="badge badge-success">Finalizada</span>
                  {% else %}
                    <span class="badge badge-secondary">{{ t.estado }}</span>
                  {% endif %}
                </td>
                <td class="align-middle">{{ t.fecha_limite|date:"d/m/Y" }}</td>
                <td class="align-middle text-right">
                  <a href="{% url 'tarea_detail' t.pk %}?src=mias" class="btn btn-sm btn-outline-primary">
                    <i class="fe fe-eye"></i> Ver
                  </a>
                  {# Si tu vista de cambio de estado ahora permite también a supervisores cambiar SU propia tarea: #}
                  <a href="{% url 'tarea_estado' t.pk %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fe fe-shuffle"></i> Cambiar estado
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">No tienes tareas asignadas.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</div>
        <nav>
          <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.estado %}estado={{ request.GET.estado|urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}"
                   aria-label="Anterior">&laquo;</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.estado %}estado={{ request.GET.estado|urlencode }}&{% endif %}page={{ page_obj.next_page_number }}"
                   aria-label="Siguiente">&raquo;</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
