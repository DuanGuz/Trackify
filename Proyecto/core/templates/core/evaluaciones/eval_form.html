{% extends "core/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-10 col-lg-8 col-xl-6">

    <!-- Título + volver -->
    <div class="d-flex align-items-center mb-3">
      <h5 class="mb-0">
        {% if form.instance.pk %}Editar evaluación{% else %}Nueva evaluación{% endif %}
      </h5>
      <a href="{% url 'eval_list_gs' %}" class="btn btn-light btn-sm ml-auto">
        <i class="fe fe-arrow-left mr-1"></i> Volver al listado
      </a>
    </div>

    <!-- Mensajes flash -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-3">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <!-- Errores globales -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger mb-3">{{ form.non_field_errors }}</div>
    {% endif %}

    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post" action="">
          {% csrf_token %}

          {# Si usas crispy, aplica layout bootstrap automáticamente #}
          {% if form|crispy %}
            {{ form|crispy }}
          {% else %}
            {{ form.as_p }}
          {% endif %}

          {# Preview simple del puntaje #}
          <div class="mt-2">
            <span class="small text-muted">Vista previa de puntaje:</span>
            <span id="puntaje-badge" class="badge badge-pill badge-secondary ml-2">—</span>
          </div>

          <div class="d-flex mt-4">
            <button type="submit" class="btn btn-primary">
              <i class="fe fe-save mr-1"></i> Guardar
            </button>
            <a href="{% url 'eval_list_gs' %}" class="btn btn-outline-secondary ml-2">
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block js %}
  {{ block.super }}
  <script>
    // Resalta el puntaje en rojo/amarillo/verde según valor
    (function () {
      // Intenta detectar el input de puntaje por su name (EvaluacionForm usa "puntaje")
      var input = document.querySelector('input[name="puntaje"], select[name="puntaje"]');
      var badge = document.getElementById('puntaje-badge');

      function setBadge(v) {
        if (!badge) return;
        var val = parseInt(v, 10);
        badge.className = 'badge badge-pill badge-secondary';
        badge.textContent = '—';

        if (!isNaN(val)) {
          badge.textContent = val + ' / 5';
          if (val >= 4)      badge.className = 'badge badge-pill badge-success';
          else if (val === 3) badge.className = 'badge badge-pill badge-warning text-dark';
          else                badge.className = 'badge badge-pill badge-danger';
        }
      }

      if (input) {
        setBadge(input.value);
        input.addEventListener('input', function (e) { setBadge(e.target.value); });
        input.addEventListener('change', function (e) { setBadge(e.target.value); });
      }
    })();
  </script>
{% endblock %}
